# Danmaku Live – User Stories (MVP)

## Epic A：認證與角色
- **A-001** 作為名單中的員工，我能輸入公司 Email 直接登入，無需密碼或 SSO。
  - AC：不在名單 → 顯示拒絕；在名單 → 1 秒內登入並顯示我的 Name/Nickname；Access 15 分鐘、Refresh 7 天。
  - 為什麼要這樣設計？  
    - 採用 Access Token（15 分鐘）+ Refresh Token（7 天）機制，是為了兼顧安全性與使用者體驗。短效的 Access Token 可以降低被盜用後的風險，萬一外洩，攻擊者能利用的時間有限；而 Refresh Token 有較長效期，讓使用者無需頻繁重新登入，系統可自動續發新的 Access Token，確保操作流暢不中斷。
- **A-002** 作為 Admin，我能指派/撤銷使用者角色（host/moderator/admin）。
  - AC：變更即時生效；寫入 `audit_logs`。

## Epic B：觀眾送訊（含匿名與表情）
- **B-001** 作為觀眾，我能輸入 1–100 字的訊息並送出。
  - AC：0 或 >100 字 → 顯示錯誤；送出成功 300ms 內顯示狀態。
- **B-002** 作為觀眾，我能勾選「匿名」並送出訊息。
  - AC：前端不顯示名稱；審核台可見帳號；匯出含 `anonymous=true`。
- **B-003** 作為觀眾，我能點擊表情按鈕（👍/😂/😭/🎉）送出表情彈幕。
  - AC：非白名單表情被拒；3 秒內連點第 2 次→節流提示。
 - **B-004** 作為觀眾，當我在 3 秒內重複送出時，能收到清楚的節流提示。
   - AC：第 2 次送出不入列；顯示統一節流訊息；提示 1s 內自動消失或可手動關閉。

## Epic C：審核與房間管控
- **C-001** 作為 Moderator，我能在佇列看到 pending 訊息並一鍵通過/拒絕。
  - AC：通過後 200ms 內向房間廣播 `message.approved`。
- **C-002** 作為 Moderator，我能清場或暫停/恢復房間。
  - AC：清場立即生效；暫停時新的訊息自動 pending。

## Epic D：大螢幕顯示（雙 Canvas）
- **D-001** 作為 Host，我能切換模式（暖場/主秀/抽獎/收尾），系統自動調整速度/軌道。
  - AC：切換後 1s 內效果生效；當前模式在 UI 顯示。
- **D-002** 作為 Host，我能看到表情雨在下層、文字彈幕在上層，互不遮蔽。
  - AC：表情與文字重疊時，文字仍清晰可讀。
 - **D-003** 作為 Host，我能即時調整文字顏色。
   - AC：切換後 1s 內對新進彈幕生效；已在畫面的彈幕維持原色；UI 顯示當前顏色。
 - **D-004** 作為 Host，我能用鍵盤快捷鍵操作（清場/暫停/加減速）。
   - AC：C=清場、P=暫停/恢復、+=加速、-=減速；觸發後 <200ms 生效；UI 顯示狀態變化。
 - **D-005** 作為 Host，我能調整表情雨密度（spawn rate）。
   - AC：調整後 1s 內體感變化明顯；高峰時啟用採樣降載；不影響文字層流暢度。

## Epic E：管理後台
- **E-001** 作為 Admin，我能建立/關閉房間與預設參數（速度、軌道、字體、文字顏色）。
- **E-002** 作為 Admin，我能設定全域禁詞或正則，並套用到多個房間。
- **E-003** 作為 Admin，我能匯出特定房間與期間的 CSV/JSON。
 - **E-004** 作為 Admin，我能管理登入名單（新增/移除/匯入）。
   - AC：支援 CSV/JSON 匯入；變更即時生效；寫入 `audit_logs`；可匯出備份。
 - **E-005** 作為 Admin，我能查看統計面板並選擇房間/時間窗。
   - AC：顯示訊息量、審核率、峰值 QPS、表情分佈；查詢延遲 <2s；可下載 CSV。
 - **E-006** 作為 Admin，我能以一致規格匯出資料。
   - AC：CSV/JSON 皆支援；欄位含 `anonymous`、`status`、`created_at`（含時區）；檔名 `room-<id>-<YYYYMMDD-HHmm>.csv`。

## Epic F：效能與穩定
- **F-001** 作為維運工程師，我希望能在儀表板上即時看到系統的關鍵指標，例如 P95 延遲（p95_latency）、每秒訊息數（msg_qps）、WebSocket 連線數（ws_connected），以便隨時掌握系統狀態。
- **F-002** 作為維運工程師，當 P95 延遲超過 1 秒且持續 1 分鐘時，我希望系統能自動發出告警通知，讓我能及時處理潛在問題。
 - **F-003** 作為使用者，當網路不穩導致斷線時，系統能自動重連與補送未送達訊息。
   - AC：WS 自動重連並最多重試 N 次；訊息具冪等 ID；恢復後自動補送且不重複；體感不中斷。

## Definition of Ready / Done
- **DoR**：需求有明確 AC、UX 草圖、後端介面定義、風險已評估。
- **DoD**：程式通過單元/整合測試；有文件（README/ENV）；通過 UAT；指標達標；記錄 Changelog。

### (D[\.\-_\s]?\d+.*|D\.|主持|大螢幕|顯示)
- **D-006（新增）**：作為主持人（Host），我可以設定同屏上限（如 120 條）與軌道數（8–12），以在高峰維持可讀性。  
- **F-004（新增）**：作為維運，我可以在儀表板看到採樣率、慢速模式狀態與每批廣播大小，方便現場調度。
