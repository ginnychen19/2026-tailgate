# Danmaku Live – Requirements (MVP)

## 1. 背景與目標
- 目的：尾牙活動現場即時互動（彈幕 + 表情），提高參與度與現場氣氛。
- KPI：P95 延遲 ≤ 1000ms；攔截率 ≥ 95%；峰值 1000 msg/min 無丟訊；現場穩定 99.9%。

## 2. 範圍（Scope）
### 2.1 In Scope
- 觀眾送出文字彈幕、**匿名留言選項**。
- **表情按鈕**：👍 😂 😭 🎉（白名單，可擴充）。
- 名單式免密碼登入（預載 Email/Name/Nickname 清單；無 SSO/密碼/IP 白名單）。
- Moderator 審核佇列、清場/暫停、房間級禁詞。
- Host 大螢幕控制（模式切換、快捷鍵）。
- Admin 房間生命周期、全域禁詞、速率與防刷、角色管理、匯出。
- Admin 登入名單管理（Allowlist 匯入/新增/移除）。
- 前端 **雙 Canvas 疊層**（上：彈幕；下：表情）。

- 文本層專責顯示觀眾送出的文字彈幕；表情層專責顯示表情（👍 😂 😭 🎉），表情採「隨機彈出→落下」效果。

### 2.2 Out of Scope（MVP）
- 圖片/貼圖彈幕、使用者自訂頭像。
- 多會場跨區同步（可列入後續 Roadmap）。

## 3. 角色與權限（摘要）
- Audience：`message:create` / `reaction:send`（受節流）。
- Moderator：審核、清場、暫停、房間禁詞、房間速率。
- Host：大螢幕顯示與模式控制（只讀統計）。
- Admin：房間、全域規則、使用者/角色、匯出、系統設定。

## 4. 主要需求（FR）
- FR-001 送出文字訊息（0–100 字，UTF-8MB4）。
- FR-002 匿名選項（前端顯示匿名；後端保留帳號與 device_hash 供審計）。
- FR-003 表情快速鍵（只能送單一 Emoji；與文字共用節流）。
- FR-004 自動審核：關鍵字/正則 → pending/reject；人工覆核通過才顯示。
- FR-005 節流：同裝置/帳號 3 秒 1 次（房間可調）。
- FR-006 大螢幕：多軌道、速度/字體/軌道數/文字顏色即時調整；快捷鍵 C/P/±。
- FR-007 名單式登入：輸入 Email，若存在於名單→直接登入並載入 Name/Nickname；無發信、無 SSO。
- FR-008 權限控管：RBAC；所有敏感操作寫入審計 Log。
- FR-009 統計：訊息量、審核率、峰值 QPS、Top 送件者、表情分佈。
- FR-010 匯出：CSV/JSON、可選房間/時間窗。

- FR-011 表情動畫（下層 Canvas）：點擊表情按鈕後，表情於隨機位置彈出並垂直落下（rain/落下效果），與文字層分離呈現；需支援密度控制與採樣降載。

- FR-012 表情密度控制：Host 可即時調整 reaction spawn rate，高峰自動啟用採樣降載。
- FR-013 登入名單管理：Admin 可新增/移除/匯入 Email/Name/Nickname/Role，並可匯出備份。
- FR-014 統計面板：可選房間與時間窗，顯示訊息量/審核率/峰值 QPS/表情分佈，支援 CSV 下載。
- FR-015 匯出規格：CSV/JSON 欄位包含 anonymous/status/created_at（含時區）；檔名 `room-<id>-<YYYYMMDD-HHmm>.csv`。
- FR-016 節流回應：觸發節流時回傳 HTTP 429，含 `Retry-After`/`X-RateLimit-Reset`，前端顯示統一節流提示。
- FR-017 斷線重連與自動重送：WS 斷線自動重連；未送達訊息具冪等 ID，恢復後自動補送且不重複。

## 5. 非功能需求（NFR）
- 效能：RPS ≥ 300；訊息體積 ≤ 1KB；WS 心跳 30s。
- 可用性：活動期間自動修復；藍綠/滾動部署不中斷（WS 支援重連）。
- 安全：XSS/HTML 清洗、CSP、WAF；JWT（15m）+ Refresh（7d）；
- 隱私：匿名前端僅不顯示名稱；後端保留追蹤（哈希處理 device_hash）。
- 相容：Chrome/Edge 最新版；4K 螢幕；Safari（Emoji 渲染 fallback）。
- i18n：預設 zh-TW，文案抽離；Emoji 白名單符號跨平台一致性。
- 可維運：結構化日誌、指標（latency、qps、error_rate）、告警（P95>1s）。

## 6. 假設 / 依賴
- 現場網路至少 20Mbps 上下行；舞台端設備 Chrome 版本可控。
- 使用者名單（Email/Name/Nickname）於活動前完成匯入或配置，並經稽核確認。

## 7. 風險與對策
- 表情海嘯 → 採樣顯示 + 峰值上限 + 主持一鍵限流。
- 大螢幕卡頓 → 降級策略（降 FPS/字體/軌道/表情生成率）。
- 名單錯漏或臨時變更 → 活動前完成名單稽核；現場提供補登管道（掃碼輸入 Email 快速登入）。

## 8. 驗收標準（AC）
- AC-001：POST→顯示 P95 ≤ 1000ms；連續 10min 壓測無丟訊。
- AC-002：匿名勾選時，任何 UI 不顯示使用者名稱；審核台仍可見真實帳號。
- AC-003：同裝置 3s 內第 2 次送出 → 顯示節流提示，不入列。
- AC-004：表情白名單以外的符號全部拒絕並提示。
- AC-005：重啟任一服務後 5s 內恢復（訊息不中斷 or 自動重送）。
- AC-006：點擊任一表情按鈕後 300ms 內在下層 Canvas 隨機位置出現並開始落下，且不遮蔽上層文字的可讀性。
- AC-007：不在名單的 Email 登入請求被拒並提示；在名單者可於 1s 內完成登入。
 - AC-008：Host 切換文字顏色後 1s 內對新進彈幕生效，已在畫面的彈幕維持原色；UI 顯示當前顏色。
 - AC-009：Host 鍵盤快捷鍵 C/P/± 觸發後 <200ms 生效，UI 顯示狀態變化。
 - AC-010：Host 調整表情密度後 1s 內體感變化明顯；高峰時自動採樣降載；文字層流暢度不受影響。
 - AC-011：Allowlist 變更即時生效；所有操作寫入 `audit_logs`；可匯出備份。
 - AC-012：統計面板查詢延遲 <2s；可下載 CSV；數據與匯出一致。
 - AC-013：匯出包含 anonymous/status/created_at（含時區）；檔名符合規則。
 - AC-014：節流時 API 回 429 並帶 `Retry-After`/`X-RateLimit-Reset`；前端顯示統一節流訊息。
 - AC-015：WS 斷線自動重連並最多重試 N 次；未送達訊息在恢復後自動補送且不重複。
